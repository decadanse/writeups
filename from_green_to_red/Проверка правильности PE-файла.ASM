;#########################################################################
;Процедура ValidPE
;Проверка правильности PE-файла
;Вход: В esi - адрес файла в памяти
;Выход: если файл правильный, то eax=1, иначе eax=0
;Заметки: обычно процедура используется с проецируемыми файлами в память
;#########################################################################
ValidPE proc
        push esi;сохраняем все регистры
        pushf;сохраняем регистр флагов
        .IF WORD ptr [esi]=="ZM"
                assume esi:ptr IMAGE_DOS_HEADER;указание компилятору, что в esi указатель на IMAGE_DOS_HEADER
                add esi,[esi].e_lfanew;переход к PE заголовку
                .IF WORD PTR [esi]=="EP"
                        popf;восстанавливаем значения флагов
                        pop esi;восстанавливаем значения регистров
                        mov eax,TRUE
                        ret
                .ENDIF
        .ENDIF
        popf;восстанавливаем значения флагов
        pop esi;восстанавливаем значения регистров      
        mov eax,FALSE
        ret
ValidPE endp
;#########################################################################
;Конец процедуры ValidPE
;#########################################################################